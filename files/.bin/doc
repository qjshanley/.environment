#!/bin/bash

find() { /usr/bin/find "$@" ; }
sed() { /usr/bin/sed "$@" ; }

main() {
    if [ ! -d "${STACKS:?The environment variable needs to be defined.}" ] ; then
        echo The STACKS environment variable is not an existing directory.
        exit 2
    fi
    stack="$(_doc_ls_ -C "$1")"
    [ "$stack" == "$1" ] && shift 1
    case $1 in
        ls)     shift 1 ; _doc_ls_ "$@" ;;
        stats)  shift 1 ; _doc_stats_ "$@" ;;
        *)      _docker-compose "$@" ;;
    esac
}

_doc_ls_() { 
    case "$1" in
        -a|--all)
            echo "$(
                for s in $(_doc_ls_) ; do
                    echo "$s"
                    sed -E 's/^/-- /' <<< "$(stack=$s ; _doc_ls_ -s)"
                done
            )"
            ;;
        -C|--check-stack)
            shift 1
            local check_stack="$(compgen -W "$(_doc_ls_)" -- "$1" | head -1)"
            if [ "$check_stack" == "$1" ] ; then
                echo "$check_stack"
                return 0
            fi
            local check_stack="$(compgen -W "$(_doc_ls_)" -- "$STACK" | head -1)"
            if [ "$check_stack" == "$STACK" ] ; then
                echo "$check_stack"
                return 0
            fi
            echo "$(_doc_ls_ | head -1)"
            ;;
        -f|--files)
            shift 1
            # These must be seperate lines or overriding won't work properly
            find -EL "$STACKS"/"$stack" -mindepth 2 -maxdepth 2 -type f -regex ".*/docker-compose$1$" | sort
            find -EL "$STACKS"/"$stack" -mindepth 1 -maxdepth 1 -type f -regex ".*/docker-compose$1$" | sort
            ;;
        -s|--services)
            shift 1
            local pads=( $'\t' '  ' '    ' )
            for config in $(_doc_ls_ -f '\.(yml|yaml)') ; do
                for pad in "${pads[@]}" ; do
                    local services="$(sed -En "/^services:/,/^[a-zA-Z]/{/^${pad}[a-zA-Z\'\"]/{s/[ :\'\"]//g;p;};}" "$config")"
                    [ "$services" ] && echo "$services" && break
                done
            done | sort | uniq
            ;;
        *|-S|--stacks)
            find "$STACKS" -mindepth 1 -maxdepth 1 \( -type d -or -type l \) -regex ".*/[^/.]*" -exec basename {} \; | sort
            ;;
    esac
}

_doc_stats_() {
    docker stats $(docker ps --format "{{.Names}}")
}

_docker-compose() {
    local cmd=$1 ; shift 1
    args+=( "$@" ) ; shift "$#" 

    # execute pre command scripts
    for f in $(_doc_ls_ -f "\.$cmd\.pre") ; do bash "$f" ; done

    # execute
    printf -v command_string -- "docker-compose%s --project-directory ${STACKS}/${stack} $cmd ${args[*]}\n" "$(printf -- " --file %s" $(_doc_ls_ -f "\.(yml|yaml)"))"
    eval "$command_string"

    # execute post command scripts
    for f in $(_doc_ls_ -f "\.$cmd\.post") ; do bash "$f" ; done
}

main "$@"
